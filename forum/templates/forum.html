{% extends 'base.html' %}
{% load static %}

{% block meta %}
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="h-8"></div>

<div class="flex flex-col items-center mt-20 bg-blue-50 w-full">
  <div class="p-2 mb-6 relative text-center">
    <h1 class="text-4xl font-bold text-blue-800 mb-4">Forum Q&A</h1>
    <p class="text-blue-600 text-lg mb-6" style="max-width: 600px;">
      Ask questions, get answers, and share your knowledge with the community. Our forum is here to help with all your health and wellness queries.
    </p>

    <a href="{% url 'forum:add_question' %}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
      Add Question
    </a>

    <div id="question_cards"></div>
</div>

<script>
  async function getQuestions(){
      return fetch("{% url 'forum:show_json_question' %}").then((res) => res.json())
  }

  function getProductById(id) {
    return fetch(`/product/json/${id}/`).then((res) => res.json());
  }

  async function refreshCards() {
    const questions = await getQuestions();
    const questionsCardContainer = document.getElementById("question_cards");

    questionsCardContainer.innerHTML = "";

    questions.sort((a, b) => b.pk - a.pk);

    for (const question of questions) {
      const questionContent = document.createElement("div");
      questionContent.className = "container my-4 py-2";

      const products = await getProductById(question.fields.drug_asked);
      const product = products[0];

      questionContent.innerHTML = `
        <div class="shadow-lg rounded-lg border border-blue-300 p-4 mb-4 transition-transform hover:scale-105 duration-300 ease-in-out card" 
     data-name="${product.fields.name}" data-id="${product.pk}">

    <div class="grid grid-cols-2 gap-2">
            <img class="w-32 h-32 object-cover rounded-lg shadow-md border border-blue-200 mb-3" 
                 src="/media/${product.fields.image}" alt="${product.fields.name}" />

        <!-- Question Title -->
        <div class="flex items-center">
            <h3 class="text-sm font-bold text-blue-800 mb-2">${question.fields.question_title}</h3>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-2 mt-2">
        <!-- Product Name -->
        <div class="flex items-center">
            <h5 class="text-sm font-bold text-blue-800 mb-2">${product.fields.name}</h5>
        </div>

        <!-- Question Text -->
        <div class="flex items-center">
            <p class="text-xs text-gray-700 mb-1">
                <span class="font-semibold text-blue-600">Question:</span> ${question.fields.question}
            </p>
        </div>
    </div>
</div>


      `;
      questionsCardContainer.appendChild(questionContent);
    };
  }

  refreshCards();

  function likeQuestion(questionId) {
    fetch(`/question/${questionId}/like/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById(`like-text-${questionId}`).textContent = data.liked ? "Unlike" : "Like";
        document.getElementById(`likes-count-${questionId}`).textContent = data.likes_count;
    })
    .catch(error => console.error('Error:', error));
  }
</script>
{% endblock content %}
